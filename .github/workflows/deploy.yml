name: Deploy to Firebase

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  buildAndDeploy:
    runs-on: ubuntu-latest
    environment: VITE_PUBLIC_FIREBASE_API_KEY
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        
    - name: Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: Build project
      run: yarn run build
      env:
        VITE_SHOPABLE_API_URL: ${{ vars.VITE_SHOPABLE_API_URL }}
        VITE_PUBLIC_FIREBASE_API_KEY: ${{ vars.VITE_PUBLIC_FIREBASE_API_KEY }}
        VITE_PUBLIC_FIREBASE_APP_ID: ${{ vars.VITE_PUBLIC_FIREBASE_APP_ID }}
        VITE_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ vars.VITE_PUBLIC_FIREBASE_AUTH_DOMAIN }}
        VITE_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.VITE_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_PUBLIC_FIREBASE_PROJECT_ID: ${{ vars.VITE_PUBLIC_FIREBASE_PROJECT_ID }}
        VITE_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ vars.VITE_PUBLIC_FIREBASE_STORAGE_BUCKET }}
      
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_DEPLOY_KEY || vars.FIREBASE_DEPLOY_KEY }}
        FIREBASE_PROJECT_ID: ${{ vars.VITE_PUBLIC_FIREBASE_PROJECT_ID }}
      run: |
        echo "Checking environment variables..."
        echo "FIREBASE_PROJECT_ID: $FIREBASE_PROJECT_ID"
        echo "FIREBASE_TOKEN length: ${#FIREBASE_TOKEN}"
        
        if [ -z "$FIREBASE_TOKEN" ] || [ "$FIREBASE_TOKEN" == "" ]; then
          echo "Error: FIREBASE_TOKEN is not set"
          echo "Please set FIREBASE_DEPLOY_KEY in GitHub Environment Secrets or Variables"
          echo "Settings → Environments → VITE_PUBLIC_FIREBASE_API_KEY"
          exit 1
        fi
        if [ -z "$FIREBASE_PROJECT_ID" ] || [ "$FIREBASE_PROJECT_ID" == "" ]; then
          echo "Error: FIREBASE_PROJECT_ID is not set"
          exit 1
        fi
        echo "Using Firebase project: $FIREBASE_PROJECT_ID"
        firebase use "$FIREBASE_PROJECT_ID" --token "$FIREBASE_TOKEN"
        firebase deploy --only hosting --token "$FIREBASE_TOKEN"
