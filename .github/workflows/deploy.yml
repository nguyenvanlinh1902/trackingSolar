name: Deploy to Firebase

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  buildAndDeploy:
    runs-on: ubuntu-latest
    environment: VITE_FIREBASE_API_KEY
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        
    - name: Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: Build project
      run: yarn run build
      env:
        VITE_SHOPABLE_API_URL: ${{ vars.VITE_SHOPABLE_API_URL }}
        VITE_ADMIN_API_KEY: ${{ vars.VITE_ADMIN_API_KEY }}
        VITE_PUBLIC_FIREBASE_API_KEY: ${{ vars.VITE_PUBLIC_FIREBASE_API_KEY }}
        VITE_PUBLIC_FIREBASE_APP_ID: ${{ vars.VITE_PUBLIC_FIREBASE_APP_ID }}
        VITE_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ vars.VITE_PUBLIC_FIREBASE_AUTH_DOMAIN }}
        VITE_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.VITE_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_PUBLIC_FIREBASE_PROJECT_ID: ${{ vars.VITE_PUBLIC_FIREBASE_PROJECT_ID }}
        VITE_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ vars.VITE_PUBLIC_FIREBASE_STORAGE_BUCKET }}
      
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ vars.FIREBASE_DEPLOY_KEY || secrets.FIREBASE_DEPLOY_KEY }}
        FIREBASE_PROJECT_ID: ${{ vars.VITE_PUBLIC_FIREBASE_PROJECT_ID }}
      run: |
        if [ -z "$FIREBASE_TOKEN" ]; then
          echo "Error: FIREBASE_TOKEN is not set. Please set FIREBASE_DEPLOY_KEY in GitHub Environment Variables or Secrets."
          exit 1
        fi
        if [ -z "$FIREBASE_PROJECT_ID" ]; then
          echo "Error: FIREBASE_PROJECT_ID is not set"
          exit 1
        fi
        echo "Deploying to Firebase project: $FIREBASE_PROJECT_ID"
        firebase deploy --only hosting --project "$FIREBASE_PROJECT_ID" --token "$FIREBASE_TOKEN" --non-interactive
